<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Minecraft Style Demo</title>
<style>
body { margin:0; overflow:hidden; background:#000; }
#ui {
 position:fixed; top:10px; left:10px; z-index:10; color:white; font-family:Arial;
}
button {
 padding:10px; margin:5px;
}
#mobile { position:fixed; bottom:20px; right:20px; display:flex; gap:10px; z-index:10; }
</style>
</head>
<body>

<div id="ui">
 <button onclick="toggleBlood()">Кровь: выкл</button>
 <button onclick="spawnMob()">Спавн моба</button>
</div>

<div id="mobile">
 <button onclick="hitMode=true">Бить</button>
 <button onclick="hitMode=false">Офф</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.162.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>

<script>
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

let camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(5,5,10);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

let controls = new THREE.OrbitControls(camera, renderer.domElement);

// свет
let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(10,10,10);
scene.add(light);

// физика
const world = new CANNON.World({
 gravity: new CANNON.Vec3(0,-9.82,0)
});

// пол
let groundBody = new CANNON.Body({
 mass:0,
 shape:new CANNON.Box(new CANNON.Vec3(50,1,50)),
 position:new CANNON.Vec3(0,-1,0)
});
world.addBody(groundBody);

let groundGeo = new THREE.BoxGeometry(100,2,100);
let groundMat = new THREE.MeshStandardMaterial({color:0x228833});
let groundMesh = new THREE.Mesh(groundGeo, groundMat);
groundMesh.position.y = -1;
scene.add(groundMesh);

let objects = [];
let bloodEnabled = false;
let hitMode = true;

// функция крови / конфетти
function particleBurst(position){
 let color = bloodEnabled ? 0xaa0000 : 0xffff00;
 for(let i=0;i<15;i++){
   let g = new THREE.SphereGeometry(0.05);
   let m = new THREE.MeshStandardMaterial({color});
   let p = new THREE.Mesh(g,m);
   p.position.copy(position);
   scene.add(p);
   let vel = new THREE.Vector3(
     (Math.random()-0.5)*3,
     Math.random()*3,
     (Math.random()-0.5)*3
   );
   let life = 60;
   p.userData.update = ()=>{
     p.position.add(vel);
     vel.y -= 0.05;
     life--;
     if(life<=0){ scene.remove(p); }
   };
   particles.push(p);
 }
}

let particles = [];

function spawnMob(){
 let size = 1;
 let boxGeo = new THREE.BoxGeometry(size,size,size);
 let boxMat = new THREE.MeshStandardMaterial({color:0x8888ff});
 let mesh = new THREE.Mesh(boxGeo, boxMat);
 mesh.position.set((Math.random()*6)-3,2,(Math.random()*6)-3);
 scene.add(mesh);

 let body = new CANNON.Body({
   mass:1,
   shape:new CANNON.Box(new CANNON.Vec3(size/2,size/2,size/2)),
   position: new CANNON.Vec3(mesh.position.x,mesh.position.y,mesh.position.z)
 });
 world.addBody(body);

 objects.push({mesh, body});
}

function toggleBlood(){
 bloodEnabled = !bloodEnabled;
 document.querySelector("#ui button").innerText = "Кровь: " + (bloodEnabled?"вкл":"выкл");
}

// Raycast удар
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();

function hit(x,y){
 if(!hitMode) return;

 mouse.x = (x / innerWidth) * 2 - 1;
 mouse.y = -(y / innerHeight) * 2 + 1;

 raycaster.setFromCamera(mouse,camera);
 let intersects = raycaster.intersectObjects(objects.map(o=>o.mesh));

 if(intersects.length>0){
   let obj = objects.find(o=>o.mesh===intersects[0].object);
   if(obj){
     obj.body.applyImpulse(
       new CANNON.Vec3((Math.random()-0.5)*10,5,(Math.random()-0.5)*10),
       obj.body.position
     );
     particleBurst(obj.mesh.position);
   }
 }
}

window.addEventListener("click", e=>hit(e.clientX,e.clientY));
window.addEventListener("touchstart", e=>{
 let t = e.touches[0];
 hit(t.clientX,t.clientY);
});

// цикл
function animate(){
 requestAnimationFrame(animate);
 world.step(1/60);

 objects.forEach(o=>{
   o.mesh.position.copy(o.body.position);
   o.mesh.quaternion.copy(o.body.quaternion);
 });

 particles.forEach(p=>p.userData.update && p.userData.update());
 renderer.render(scene,camera);
}

animate();
</script>
</body>
</html>
